<!DOCTYPE html>
<html lang="ru"><head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Ruby 2.0, что нас ждет?</title>
    <meta name="description">
    <meta name="keywords">
    <meta content="kV0pbQhJgmKN4HYX_lWYGipG-w7cKmFleQ-4ZbkAQX0" name="google-site-verification"><link href="../../favicon.png?1354701016" rel="icon" type="image/png" /><link href="../../stylesheets/reset.css?1354701016" media="screen" rel="stylesheet" type="text/css" /><link href="../../stylesheets/main.css?1354701016" media="screen" rel="stylesheet" type="text/css" /><link href="../../stylesheets/syntax.css?1354701016" media="screen" rel="stylesheet" type="text/css" /><script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
    <script src="../../javascripts/core.js?1354701016" type="text/javascript"></script></head><body>
    <div id="container"><div id="header">
        <div class="logo">
          <a href="/"><img src="/images/logo_hover.png"><img class="overlay" src="/images/logo.png"></a>
        </div>
        <div class="about">
          <h1>
            <a href="/">artemeff</a> &mdash; Ruby on Rails developer</h1>
          <span>Программы должны быть написаны так, чтобы их могли читать люди, и лишь иногда так, чтобы их могли выполнять машины.</span>
        </div>
        <div class="navigation">
          <a href="/">Главная</a><br><a href="/projects.html">Проекты</a><br><a href="/contacts.html">Контакты</a><br><a href="/about_me.html">Кто такой?</a>
        </div>
      </div>
      <div class="line"></div><div id="main">
        <div class="posts">
          <div class="post">
            <div class="meta">Ноябрь 25, 2012<p>
                <a href="#comments">комментарии</a>
              </p>
              <ul class="tags">
                <li>
                  <a href="/tags/ruby.html">ruby</a>
                </li>
                <li>
                  <a href="/tags/rvm.html">rvm</a>
                </li>
                <li>
                  <a href="/tags/test.html">test</a>
                </li>
                <li>
                  <a href="/tags/performance.html">performance</a>
                </li>
              </ul>
            </div>
            <div class="article">
              <h1 class="title">Ruby 2.0, что нас ждет?</h1><p>2 ноября <a href="http://www.ruby-lang.org/zh_TW/news/2012/11/02/ruby-2-0-0-preview1-released/">вышла</a> <a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-dev/46348">первая</a> <a href="https://github.com/ruby/ruby/commit/6b8d4ab840b2d76d356ba30dbccfef4f5fd10767">версия</a> Ruby 2.0. По плану, 24 февряля 2013 года выйдет 2.0.0-p0, что значит &mdash; релиз, но пока не для продакшна. </p>
<h2 id="daty-vyhoda">Даты выхода</h2>
<ul>
<li>Начало декабря: 2.0.0-preview2</li>
<li>После нового года: 2.0.0-rc1</li>
<li>Начало февраля: 2.0.0-rc2</li>
<li>24 февраля: 2.0.0-p0</li>
</ul>
<h2 id="novoe-v-2-0-0">Новое в 2.0.0</h2>
<ul>
<li><a href="#refinements">Refinements</a></li>
<li><a href="#keyword-arguments">Keyword arguments</a></li>
<li>Enumerator#lazy</li>
<li><a href="#module-prepend">Module#prepend</a></li>
<li><a href="#converting-convention-to-hash-to_h">Converting convention to Hash: #to_h</a></li>
<li><a href="#i-a-literal-for-symbol-array">%i: a literal for symbol array</a></li>
<li>Новый движок регулярных выражений &mdash; <a href="https://github.com/k-takata/Onigmo">Onigmo</a></li>
<li>Поддержка <a href="http://ru.wikipedia.org/wiki/DTrace">DTrace</a> (<em>будет в версии preview2</em>)</li>
<li>Импорт/экспорт байткода</li>
<li>Стандартные библиотеки станут гемами</li>
<li>Переход на UTF</li>
</ul>
<h3 id="refinements">Refinements</h3>
<p>Давайте рассмотрим следующий кусок кода:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">module</span> <span class="class">NumberQuery</span>
  refine <span class="constant">String</span> <span class="keyword">do</span>
    <span class="keyword">def</span> <span class="function">number?</span>
      match(<span class="regexp"><span class="delimiter">/</span><span class="content">^[1-9][0-9]+$</span><span class="delimiter">/</span></span>) ? <span class="predefined-constant">true</span> : <span class="predefined-constant">false</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>И попробуем вызвать его:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">begin</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>.number?
<span class="keyword">rescue</span> =&gt; e
  p e  <span class="comment">#=&gt; #&lt;NoMethodError: undefined method `number?' for &quot;123&quot;:String&gt;</span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>Этот метод недоступен в глобальном пространстве, но его можно использовать внутри модуля <strong>NumberQuery</strong>:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">module</span> <span class="class">NumberQuery</span>
  p <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>.number?  <span class="comment"># =&gt; true</span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>Так-же этот метод можно добавить в другой модуль:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">module</span> <span class="class">MyApp</span>
  using <span class="constant">NumberQuery</span>

  p <span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>.number?  <span class="comment"># =&gt; true</span>
  p <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>.number?  <span class="comment"># =&gt; false</span>
<span class="keyword">end</span>
</pre></div>
</div>
<h3 id="keyword-arguments">Keyword arguments</h3>
<p>Новая фича простая, но очень удобная, это как новые хеши в 1.9, к которым я до сих пор не могу привыкнуть и использую старый вид :)</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">def</span> <span class="function">wrap</span>(string, before: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;</span><span class="delimiter">&quot;</span></span>, after: <span class="string"><span class="delimiter">&quot;</span><span class="content">&gt;</span><span class="delimiter">&quot;</span></span>)
  <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">#{</span>before<span class="inline-delimiter">}</span></span><span class="inline"><span class="inline-delimiter">#{</span>string<span class="inline-delimiter">}</span></span><span class="inline"><span class="inline-delimiter">#{</span>after<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> <span class="comment"># в теле как переменная,</span>
                               <span class="comment"># в параметрах как хеш</span>
<span class="keyword">end</span>

<span class="comment"># опциональное использование</span>
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>)                                  <span class="comment"># =&gt; &quot;&lt;foo&gt;&quot;</span>
<span class="comment"># один или другой</span>
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, before: <span class="string"><span class="delimiter">&quot;</span><span class="content">#&lt;</span><span class="delimiter">&quot;</span></span>)                    <span class="comment"># =&gt; &quot;#&lt;foo&gt;&quot;</span>
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, after: <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>)                      <span class="comment"># =&gt; &quot;&lt;foo]&quot;</span>
<span class="comment"># порядок не важен</span>
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, after: <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, before: <span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="delimiter">&quot;</span></span>)         <span class="comment"># =&gt; &quot;[foo]&quot;</span>

<span class="comment"># две звезды для захвата всех аргументов</span>
<span class="comment"># или использование аргументов в виде хеша</span>
<span class="keyword">def</span> <span class="function">capture</span>(**opts)
  opts
<span class="keyword">end</span>
p capture(foo: <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>)                          <span class="comment"># =&gt; {:foo=&gt;&quot;bar&quot;}</span>

<span class="comment"># ключи можно использовать как символы</span>
opts = {<span class="symbol">:before</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">(</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:after</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>}
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, **opts)                          <span class="comment"># =&gt; &quot;(foo)&quot;</span>

<span class="comment"># можно использовать старый вид хешей</span>
p wrap(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:before</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:after</span> =&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span>)   <span class="comment"># =&gt; &quot;{foo}&quot;</span>
</pre></div>
</div>
<h3 id="module-prepend">Module#prepend</h3>
<p>Тоже очень полезное нововведение, комментарии и объяснения излишне.</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">module</span> <span class="class">A</span>
  <span class="keyword">def</span> <span class="function">foo</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></div>
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">class</span> <span class="class">B</span>
  include <span class="constant">A</span>

  <span class="keyword">def</span> <span class="function">foo</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

p <span class="constant">B</span>.new.foo   <span class="comment"># =&gt; &quot;B&quot;</span>
</pre></div>
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">class</span> <span class="class">C</span>
  prepend <span class="constant">A</span>

  <span class="keyword">def</span> <span class="function">foo</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

p <span class="constant">C</span>.new.foo   <span class="comment"># =&gt; &quot;A&quot;</span>
</pre></div>
</div>
<h3 id="converting-convention-to-hash-to_h">Converting convention to Hash: #to_h</h3><div class="CodeRay">
  <div class="code"><pre><span class="keyword">def</span> <span class="function">foo</span>(opts)
  raise <span class="constant">ArgumentError</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">opts must be a Hash</span><span class="delimiter">&quot;</span></span> <span class="keyword">unless</span> opts.is_a?(<span class="constant">Hash</span>)
  <span class="comment"># do stuff with opts</span>
<span class="keyword">end</span>
</pre></div>
</div>

<p>Теперь можно добавить универсальности:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="keyword">def</span> <span class="function">foo</span>(options)
  <span class="keyword">if</span> options.respond_to?(<span class="symbol">:to_h</span>)
    opts = options.to_h
  <span class="keyword">else</span>
    raise <span class="constant">TypeError</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">can't convert </span><span class="inline"><span class="inline-delimiter">#{</span>options.inspect<span class="inline-delimiter">}</span></span><span class="content"> into Hash</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
  <span class="comment"># do stuff with opts</span>
<span class="keyword">end</span>
</pre></div>
</div>
<h3 id="i-a-literal-for-symbol-array">%i: a literal for symbol array</h3><div class="CodeRay">
  <div class="code"><pre>p %i{hurray huzzah whoop}   <span class="comment"># =&gt; [:hurray, :huzzah, :whoop]</span>
</pre></div>
</div>
<h2 id="ustanovka-i-testirovanie-novoy-versii-ruby-2-0-0-preview1">Установка и тестирование новой версии (ruby-2.0.0-preview1)</h2>
<p>Этот кусок статьи не мой, его я нагло позаимствовал у <a href="http://igor-alexandrov.github.com/blog/2012/11/05/yet-another-ruby-shootout/">Александрова Игоря</a> :)</p>

<p>Железо:</p>

<ul>
<li>OS: OSX 10.8.2</li>
<li>CPU: 2.2GHz i7</li>
<li>RAM: 8Gb 1333 MHz DDR3</li>
<li>HHD: Seagate Momentus XT, 2.5”, SATA 3Gb/s, 7200 rpm, hybrid</li>
</ul>

<p><a href="https://github.com/acangiano/ruby-benchmark-suite">Набор тестов</a>.</p>

<p>Установка:</p>
<div class="CodeRay">
  <div class="code"><pre>$ export CC=clang # http://bugs.ruby-lang.org/issues/7264
$ rvm install ruby-2.0.0-preview1
</pre></div>
</div>

<p>Результаты тестирования:</p>

<p><img alt="Total seconds" src="Ruby-2-0/total_seconds.png?1354701016" />
<img alt="Mean seconds" src="Ruby-2-0/mean_seconds.png?1354701016" /></p>
</div>
          </div><div class="post comments" id="comments">
            <div class="meta">
              <h6>Комментарии</h6>
            </div>
            <div class="article">
              <div id="disqus_thread"></div>
              <script type="text/javascript">var disqus_shortname = 'artemeff';
                
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();</script>
              <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">>comments powered by Disqus.</a></noscript>
            </div>
          </div></div><div class="slider">
          <a href="/blog/2012/Ram-ssd-hdd.html" title="Тестируем RAM, SSD и HDD на скорость">« назад</a><a href="/blog/2012/Ruby-performance.html" title="Ruby, cloud vs dedicated и проблемы rvm">вперед »</a>
        </div></div>
    </div>
    <script type="text/javascript">var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-27383670-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();</script>
  </body>
</html>